#!/bin/bash

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

REPO="nekorosys/nekoroshell"
TEMP_DIR="/tmp/nekoroshell_upgrade"

usage() {
    echo -e "${BLUE}NeKoRoSHELL Management Utility${NC}\n"
    echo -e "Usage: nekoroshell [COMMAND]\n"
    echo -e "Commands:"
    echo -e "  ${GREEN}update${NC}      Fetch and apply the latest NeKoRoSHELL release."
    echo -e "  ${RED}uninstall${NC}   Remove all NeKoRoSHELL configurations and scripts from the system."
    echo ""
    exit 1
}

clean_shell_rc() {
    local shell_rc="$1"
    if [[ -f "$shell_rc" ]]; then
        if grep -q "# --- NeKoRoSHELL START ---" "$shell_rc"; then
            sed -i '/# --- NeKoRoSHELL START ---/,/# --- NeKoRoSHELL END ---/d' "$shell_rc"
            echo -e "  Cleaned ${GREEN}$shell_rc${NC}"
        fi
    fi
}

prompt_merge() {
    local new_file="$1"
    local target_file="$2"
    local relative_path="${target_file#$HOME/}"

    while true; do
        echo -e "\n${YELLOW}Conflict detected in: ${NC}$relative_path"
        echo -ne "Action: [${GREEN}o${NC}]verwrite, [${RED}k${NC}]eep current, [${BLUE}v${NC}]iew diff, [${YELLOW}m${NC}]erge? "
        
        read -r -n 1 choice 
        echo ""
        
        case "${choice,,}" in
            o)
                cp "$new_file" "$target_file"
                echo -e "${GREEN}Overwritten.${NC}"
                break ;;
            k)
                echo -e "${YELLOW}Kept current version.${NC}"
                break ;;
            v)
                diff --color=always -u "$target_file" "$new_file" | less -R
                ;;
            m)
                USER_EDITOR=${VISUAL:-${EDITOR:-nano}}

                echo -e "${BLUE}Opening merge review in $USER_EDITOR...${NC}"

                if [ "$USER_EDITOR" = "code" ]; then
                    # We add --wait so the script pauses until you close the tab
                    code --wait --diff "$target_file" "$new_file"
                else
                    # Fallback to standard editor (vim, nano, etc.)
                    $USER_EDITOR "$new_file"
                fi
                break ;;
            *)
                echo -e "${RED}Invalid choice. Please press o, k, v, or m.${NC}" ;;
        esac
    done
}

do_uninstall() {
    echo -e "# ======================================================= #"
    echo -e "#              NeKoRoSHELL Uninstallation Utility         #"
    echo -e "# ======================================================= #\n"

    echo -e "${YELLOW}WARNING: This script will remove all NeKoRoSHELL configurations, scripts, and services.${NC}"
    echo -e "System packages (Hyprland, Waybar, etc.) will NOT be uninstalled."
    echo -e "If backups of your original configs exist, this script will attempt to restore them.\n"

    echo -ne "${RED}Are you absolutely sure you want to proceed? (y/n): ${NC}"
    read -r confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "${GREEN}Uninstallation aborted.${NC}"
        exit 0
    fi

    echo -e "\n${BLUE}Stopping and disabling NeKoRoSHELL services...${NC}"

    if command -v systemctl >/dev/null 2>&1; then
        SERVICES=("waybar" "swaync" "navbar" "navbar-hover" "navbar-watcher")
        
        for svc in "${SERVICES[@]}"; do
            if systemctl --user is-active --quiet "$svc.service" 2>/dev/null; then
                systemctl --user stop "$svc.service" 2>/dev/null
            fi
            if systemctl --user is-enabled --quiet "$svc.service" 2>/dev/null; then
                systemctl --user disable "$svc.service" 2>/dev/null
            fi
        done
        
        rm -f "$HOME/.config/systemd/user/navbar"*
        systemctl --user daemon-reload
        echo -e "${GREEN}Services stopped and removed.${NC}"
    fi

    echo -e "\n${BLUE}Removing NeKoRoSHELL configs and restoring backups...${NC}"

    CONFIGS=(btop cava fastfetch hypr hypremoji kitty rofi swaync themes wallpapers wallust waybar wlogout)

    for conf in "${CONFIGS[@]}"; do
        target_dir="$HOME/.config/$conf"
        if [[ -d "$target_dir" ]]; then
            rm -rf "$target_dir"
            echo -e "  Removed ${YELLOW}$conf${NC} configuration."
        fi
    done

    latest_backup=$(ls -1 "$HOME/nekoroshell_backup_"*.tar.gz 2>/dev/null | sort -V | tail -n 1)
    
    if [[ -n "$latest_backup" ]]; then
        echo -e "\n${BLUE}Restoring from backup archive: $(basename "$latest_backup")...${NC}"
        tar -xzf "$latest_backup" -C "$HOME/.config"
        echo -e "  [${GREEN}Restored${NC}] Configurations recovered from tarball."
    else
        echo -e "  ${YELLOW}No tarball backup found to restore.${NC}"
    fi

    echo -e "\n${BLUE}Cleaning up NeKoRoSHELL scripts and binaries...${NC}"

    for bin_dir in "$HOME/.local/bin/nekoroshell" "$HOME/bin/nekoroshell"; do
        if [[ -d "$bin_dir" ]]; then
            rm -rf "$bin_dir"
            echo -e "  Removed directory: ${YELLOW}$bin_dir${NC}"
        fi
    done

    for misc_file in .p10k.zsh .face.icon change-avatar.sh; do
        if [[ -f "$HOME/$misc_file" ]]; then
            rm -f "$HOME/$misc_file"
            echo -e "  Removed file: ${YELLOW}$misc_file${NC}"
        fi
    done

    echo -e "\n${BLUE}Removing injected NeKoRoSHELL path variables from shell profiles...${NC}"

    clean_shell_rc "$HOME/.bashrc"
    clean_shell_rc "$HOME/.zshrc"

    echo -e "\n${GREEN}Uninstallation complete!${NC}"
    echo -e "You may need to log out and log back in, or restart your computer, for all changes to fully take effect."
}

do_update() {
    echo -e "# ======================================================= #"
    echo -e "#              NeKoRoSHELL Upgrade Utility                #"
    echo -e "# ======================================================= #\n"

    echo -e "${BLUE}Fetching latest release info from GitHub...${NC}"
    LATEST_TAG=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    TARBALL_URL=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" | grep '"tarball_url":' | sed -E 's/.*"([^"]+)".*/\1/')

    if [[ -z "$LATEST_TAG" || -z "$TARBALL_URL" ]]; then
        echo -e "${RED}Error: Could not fetch release data. Are you connected to the internet?${NC}"
        exit 1
    fi

    echo -e "${GREEN}Latest release found: $LATEST_TAG${NC}\n"

    echo -ne "${YELLOW}Do you want to proceed with the upgrade to $LATEST_TAG? (y/n): ${NC}"
    read -r confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "${RED}Upgrade aborted by user.${NC}"
        exit 0
    fi

    echo -e "\n${BLUE}Creating backup before update...${NC}"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_ARCHIVE="$HOME/nekoroshell_backup_$TIMESTAMP.tar.gz"
    BACKUP_ITEMS=()
    CONFIGS=(btop cava fastfetch hypr hypremoji kitty rofi swaync systemd wallpapers wallust waybar wlogout themes)

    mkdir -p "$HOME/.config"
    for conf in "${CONFIGS[@]}"; do
        if [[ -e "$HOME/.config/$conf" ]]; then
            BACKUP_ITEMS+=("$conf")
        fi
    done

    if [[ ${#BACKUP_ITEMS[@]} -gt 0 ]]; then
        tar -czf "$BACKUP_ARCHIVE" -C "$HOME/.config" "${BACKUP_ITEMS[@]}"
        echo -e "${GREEN}Created pre-update backup archive at: $BACKUP_ARCHIVE${NC}"
    else
        echo -e "${YELLOW}No existing configs found to backup. Proceeding...${NC}"
    fi

    echo -e "\n${BLUE}Downloading and extracting...${NC}"

    rm -rf "$TEMP_DIR"
    mkdir -p "$TEMP_DIR"
    curl -sL "$TARBALL_URL" | tar -xz -C "$TEMP_DIR" --strip-components=1

    if [[ ! -d "$TEMP_DIR/.config" ]]; then
        echo -e "${RED}Error: Extraction failed or invalid repository structure.${NC}"
        exit 1
    fi

    echo -e "${BLUE}Pre-processing downloaded files to match your system...${NC}"

    find "$TEMP_DIR/.config" -type f \( -name "*.conf" -o -name "*.json" -o -name "*.jsonc" -o -name "*.css" -o -name "*.rasi" -o -name "*.sh" \) -print0 2>/dev/null | xargs -0 -r sed -i "s|/home/nekorosys|$HOME|g"

    declare -a MONITOR_LIST
    if [[ -n "$HYPRLAND_INSTANCE_SIGNATURE" ]] && command -v hyprctl &> /dev/null; then
        mapfile -t MONITOR_LIST < <(hyprctl monitors | awk '/Monitor/ {print $2}')
    else
        for f in /sys/class/drm/*/status; do
            if grep -q "^connected$" "$f" 2>/dev/null; then
                monitor_name=$(basename "$(dirname "$f")" | sed -E 's/^card[0-9]+-//')
                [[ ! " ${MONITOR_LIST[*]} " =~ " ${monitor_name} " ]] && MONITOR_LIST+=("$monitor_name")
            fi
        done
    fi

    echo -e "\n${BLUE}Comparing configurations...${NC}"

    while IFS= read -r -u 3 new_file; do
        relative_path="${new_file#$TEMP_DIR/}"
        target_file="$HOME/$relative_path"
        target_dir=$(dirname "$target_file")

        if [[ ! -f "$target_file" ]]; then
            mkdir -p "$target_dir"
            cp "$new_file" "$target_file"
            echo -e "${GREEN}Added new file:${NC} $relative_path"
            continue
        fi

        if ! cmp -s "$new_file" "$target_file"; then
            prompt_merge "$new_file" "$target_file"
        fi
    done 3< <(find "$TEMP_DIR/.config" -type f)

    echo -e "\n${BLUE}Verifying user configuration sandbox...${NC}"

    USER_CONF_DIR="$HOME/.config/hypr/user/configs"
    USER_SCRIPT_DIR="$HOME/.config/hypr/user/scripts"
    TEMPLATE_DIR="$HOME/.config/hypr/user/templates"

    mkdir -p "$USER_CONF_DIR"
    mkdir -p "$USER_SCRIPT_DIR"

    if [[ -d "$TEMPLATE_DIR" ]]; then
        for file in "$TEMPLATE_DIR"/*.conf; do
            [ -e "$file" ] || continue
            filename=$(basename "$file")
            if [ ! -f "$USER_CONF_DIR/$filename" ]; then
                cp "$file" "$USER_CONF_DIR/$filename"
                echo -e "  [${GREEN}New${NC}] Initialized missing user config: $filename"
            fi
        done
    fi

    if [ ! -f "$USER_SCRIPT_DIR/autostart.sh" ]; then
        echo "#!/bin/bash" > "$USER_SCRIPT_DIR/autostart.sh"
        echo "# Add your personal startup commands here" >> "$USER_SCRIPT_DIR/autostart.sh"
        chmod +x "$USER_SCRIPT_DIR/autostart.sh"
        echo -e "  [${GREEN}New${NC}] Initialized user autostart script."
    fi

    if [[ ${#MONITOR_LIST[@]} -gt 0 ]]; then
        PRIMARY_MONITOR=${MONITOR_LIST[0]}
        SECONDARY_MONITOR=${MONITOR_LIST[1]:-$PRIMARY_MONITOR}
        
        if [[ -d "$USER_CONF_DIR" ]]; then
            find "$USER_CONF_DIR" -type f -name "*.conf" -exec sed -i "s/__PRIMARY_MONITOR__/$PRIMARY_MONITOR/g" {} +
            if [[ ${#MONITOR_LIST[@]} -ge 2 ]]; then
                find "$USER_CONF_DIR" -type f -name "*.conf" -exec sed -i "s/__SECONDARY_MONITOR__/$SECONDARY_MONITOR/g" {} +
            else
                find "$USER_CONF_DIR" -type f -name "*.conf" -exec sed -i '/monitor=__SECONDARY_MONITOR__/s/^/#/' {} +
            fi
        fi
    fi

    echo -e "\n${BLUE}Scanning for and removing legacy root-level scripts...${NC}"

    for legacy_dir in "$HOME/.local/bin" "$HOME/bin"; do
        if [[ -d "$legacy_dir" ]]; then
            for new_script in "$TEMP_DIR/bin/"*; do
                if [[ -f "$new_script" ]]; then
                    script_name=$(basename "$new_script")
                    
                    if [[ -f "$legacy_dir/$script_name" ]]; then
                        echo -e "${YELLOW}Removing old script to prevent conflicts:${NC} $legacy_dir/$script_name"
                        rm -f "$legacy_dir/$script_name"
                    fi
                fi
            done
        fi
    done

    echo -e "\n${BLUE}Updating core scripts and binaries...${NC}"

    if [[ -d "$HOME/.local/bin/nekoroshell" ]]; then
        BIN_DIR="$HOME/.local/bin/nekoroshell"
    elif [[ -d "$HOME/bin/nekoroshell" ]]; then
        BIN_DIR="$HOME/bin/nekoroshell"
    else
        BIN_DIR="$HOME/.local/bin/nekoroshell"
        mkdir -p "$BIN_DIR"
    fi

    if [[ -d "$TEMP_DIR/bin" ]]; then
        cp -r "$TEMP_DIR/bin/"* "$BIN_DIR/" 2>/dev/null
        chmod +x "$BIN_DIR"/* 2>/dev/null
        echo -e "${GREEN}Successfully updated bash scripts in $BIN_DIR${NC}"
    fi

    echo -e "${BLUE}Recompiling C++ Daemons...${NC}"
    if ! command -v g++ &> /dev/null || ! command -v pkg-config &> /dev/null; then
        echo -e "${RED}Warning: g++ or pkg-config not found. Skipping C++ recompilation.${NC}"
    else
        REQUIRED_LIBS="wayland-client" 
        if ! pkg-config --exists $REQUIRED_LIBS; then
            echo -e "${RED}Warning: Missing development headers for $REQUIRED_LIBS. Skipping compilation.${NC}"
        else
            LIBS=$(pkg-config --cflags --libs $REQUIRED_LIBS)

            if [[ -f "$TEMP_DIR/src/navbar-hover.cpp" ]]; then
                g++ -O3 -o "$BIN_DIR/navbar-hover" "$TEMP_DIR/src/navbar-hover.cpp" $LIBS
                echo -e "  [${GREEN}OK${NC}] Compiled navbar-hover"
            fi
            
            if [[ -f "$TEMP_DIR/src/navbar-watcher.cpp" ]]; then
                g++ -O3 -o "$BIN_DIR/navbar-watcher" "$TEMP_DIR/src/navbar-watcher.cpp" $LIBS
                echo -e "  [${GREEN}OK${NC}] Compiled navbar-watcher"
            fi
            
            if [[ -f "$TEMP_DIR/src/hypr-nice.cpp" ]]; then
                g++ -O3 -o "$BIN_DIR/hypr-nice" "$TEMP_DIR/src/hypr-nice.cpp"
                echo -e "  [${GREEN}OK${NC}] Compiled hypr-nice"
            fi

            if [[ -f "$TEMP_DIR/src/eject-forbidden.cpp" ]]; then
                g++ -O3 -o "$BIN_DIR/eject-forbidden" "$TEMP_DIR/src/eject-forbidden.cpp"
                echo -e "  [${GREEN}OK${NC}] Compiled eject-forbidden"
            fi
        fi
    fi

    rm -rf "$TEMP_DIR"

    if command -v hyprctl >/dev/null 2>&1; then
        hyprctl reload >/dev/null 2>&1
    fi

    echo -e "${GREEN}Upgrade to $LATEST_TAG complete!${NC}"
}

if [ $# -eq 0 ]; then
    usage
fi

case "$1" in
    update|upgrade)
        do_update
        ;;
    uninstall|remove)
        do_uninstall
        ;;
    *)
        usage
        ;;
esac
