#!/bin/bash

set -euo pipefail

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

REPO="nekorosys/nekoroshell"
TEMP_DIR="/tmp/nekoroshell_upgrade"
CONF_DIR=${XDG_CONFIG_HOME:-$HOME/.config}

usage() {
    echo -e "${BLUE}NeKoRoSHELL Management Utility${NC}\n"
    echo -e "Usage: nekoroshell [COMMAND]\n"
    echo -e "Commands:"
    echo -e "  ${GREEN}update${NC}        Fetch and apply the latest NeKoRoSHELL release."
    echo -e "  ${GREEN}create-skin${NC}   Create a new empty skin template for a specific feature."
    echo -e "  ${GREEN}create-theme${NC}  Create a new theme script bundle from existing skins."
    echo -e "  ${RED}uninstall${NC}     Remove all NeKoRoSHELL configurations and scripts."
    echo ""
    exit 1
}

clean_shell_rc() {
    local shell_rc="$1"
    if [[ -f "$shell_rc" ]]; then
        if grep -q "# --- NeKoRoSHELL START ---" "$shell_rc"; then
            sed -i '/# --- NeKoRoSHELL START ---/,/# --- NeKoRoSHELL END ---/d' "$shell_rc"
            echo -e "  Cleaned ${GREEN}$shell_rc${NC}"
        fi
    fi
}

prompt_merge() {
    local new_file="$1"
    local target_file="$2"
    local relative_path="${target_file#$HOME/}"

    while true; do
        echo -e "\n${YELLOW}Conflict detected in: ${NC}$relative_path"
        echo -ne "Action: [${GREEN}o${NC}]verwrite, [${RED}k${NC}]eep current, [${BLUE}v${NC}]iew diff, [${YELLOW}m${NC}]erge? "
        
        read -r -n 1 choice 
        echo ""
        
        case "${choice,,}" in
            o)
                cp "$new_file" "$target_file"
                echo -e "${GREEN}Overwritten.${NC}"
                break ;;
            k)
                echo -e "${YELLOW}Kept current version.${NC}"
                break ;;
            v)
                diff --color=always -u "$target_file" "$new_file" | less -R
                ;;
            m)
                USER_MERGE_TOOL="${MERGE_TOOL:-vimdiff}"
                
                if ! command -v "$USER_MERGE_TOOL" &> /dev/null; then
                    echo -e "${BLUE}$USER_MERGE_TOOL not found. Falling back to diff3...${NC}"
                    
                    if diff3 -m "$target_file" "$target_file" "$new_file" > "${target_file}.tmp_merge"; then
                        mv "${target_file}.tmp_merge" "$target_file"
                        echo -e "${GREEN}Merged cleanly using diff3.${NC}"
                    else
                        echo -e "${YELLOW}Merge conflicts found! Opening in your standard editor to resolve manually...${NC}"
                        USER_EDITOR=${VISUAL:-${EDITOR:-nano}}
                        command -v "$USER_EDITOR" >/dev/null 2>&1 || USER_EDITOR="vi"
                        
                        $USER_EDITOR "${target_file}.tmp_merge"
                        mv "${target_file}.tmp_merge" "$target_file"
                    fi
                else
                    echo -e "${BLUE}Opening merge review in $USER_MERGE_TOOL...${NC}"
                    if [ "$USER_MERGE_TOOL" = "code" ]; then
                        code --wait --diff "$target_file" "$new_file"
                    else
                        "$USER_MERGE_TOOL" "$target_file" "$new_file"
                    fi
                fi
                break ;;
            *)
                echo -e "${RED}Invalid choice. Please press o, k, v, or m.${NC}" ;;
        esac
    done
}

do_uninstall() {
    echo -e " ======================================================= #"
    echo -e "#              NeKoRoSHELL Uninstallation Utility         #"
    echo -e "# ======================================================= #\n"

    echo -e "${YELLOW}WARNING: This script will remove all NeKoRoSHELL configurations, scripts, and services.${NC}"
    echo -e "System packages (Hyprland, Waybar, etc.) will NOT be uninstalled."
    echo -e "If backups of your original configs exist, this script will attempt to restore them.\n"

    echo -ne "${RED}Are you absolutely sure you want to proceed? (y/n): ${NC}"
    read -r confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "${GREEN}Uninstallation aborted.${NC}"
        exit 0
    fi

    echo -e "\n${BLUE}Stopping and disabling NeKoRoSHELL services...${NC}"

    if command -v systemctl >/dev/null 2>&1; then
        SERVICES=("waybar" "swaync" "navbar" "navbar-hover" "navbar-watcher")
        
        for svc in "${SERVICES[@]}"; do
            if systemctl --user is-active --quiet "$svc.service" 2>/dev/null; then
                systemctl --user stop "$svc.service" 2>/dev/null
            fi
            if systemctl --user is-enabled --quiet "$svc.service" 2>/dev/null; then
                systemctl --user disable "$svc.service" 2>/dev/null
            fi
        done
        
        rm -f "$CONF_DIR/systemd/user/navbar"*
        systemctl --user daemon-reload
        echo -e "${GREEN}Services stopped and removed.${NC}"
    fi

    echo -e "\n${BLUE}Removing NeKoRoSHELL configs and restoring backups...${NC}"

    CONFIGS=(btop cava fastfetch hypr hypremoji kitty rofi swaync themes wallpapers wallust waybar wlogout)

    for conf in "${CONFIGS[@]}"; do
        target_dir="$CONF_DIR/$conf"
        if [[ -d "$target_dir" ]]; then
            rm -rf "$target_dir"
            echo -e "  Removed ${YELLOW}$conf${NC} configuration."
        fi
    done

    latest_backup=$(ls -1 "$HOME/nekoroshell_backup_"*.tar.gz 2>/dev/null | sort -V | tail -n 1)
    
    if [[ -n "$latest_backup" ]]; then
        echo -e "\n${BLUE}Restoring from backup archive: $(basename "$latest_backup")...${NC}"
        tar -xzf "$latest_backup" -C "$CONF_DIR"
        echo -e "  [${GREEN}Restored${NC}] Configurations recovered from tarball."
    else
        echo -e "  ${YELLOW}No tarball backup found to restore.${NC}"
    fi

    echo -e "\n${BLUE}Cleaning up NeKoRoSHELL scripts and binaries...${NC}"

    for bin_dir in "$HOME/.local/bin/nekoroshell" "$HOME/bin/nekoroshell"; do
        if [[ -d "$bin_dir" ]]; then
            rm -rf "$bin_dir"
            echo -e "  Removed directory: ${YELLOW}$bin_dir${NC}"
        fi
    done

    for misc_file in .p10k.zsh .face.icon change-avatar.sh; do
        if [[ -f "$HOME/$misc_file" ]]; then
            rm -f "$HOME/$misc_file"
            echo -e "  Removed file: ${YELLOW}$misc_file${NC}"
        fi
    done

    echo -e "\n${BLUE}Removing injected NeKoRoSHELL path variables from shell profiles...${NC}"

    clean_shell_rc "$HOME/.bashrc"
    clean_shell_rc "$HOME/.zshrc"

    echo -e "\n${GREEN}Uninstallation complete!${NC}"
    echo -e "You may need to log out and log back in, or restart your computer, for all changes to fully take effect."
}

do_update() {
    echo -e "# ======================================================= #"
    echo -e "#              NeKoRoSHELL Upgrade Utility                #"
    echo -e "# ======================================================= #\n"

    echo -e "${BLUE}Fetching latest release info from GitHub...${NC}"
    LATEST_TAG=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    TARBALL_URL=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" | grep '"tarball_url":' | sed -E 's/.*"([^"]+)".*/\1/')

    if [[ -z "$LATEST_TAG" || -z "$TARBALL_URL" ]]; then
        echo -e "${RED}Error: Could not fetch release data. Are you connected to the internet?${NC}"
        exit 1
    fi

    echo -e "${GREEN}Latest release found: $LATEST_TAG${NC}\n"

    echo -ne "${YELLOW}Do you want to proceed with the upgrade to $LATEST_TAG? (y/n): ${NC}"
    read -r confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo -e "${RED}Upgrade aborted by user.${NC}"
        exit 0
    fi

    echo -e "\n${BLUE}Creating backup before update...${NC}"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_ARCHIVE="$HOME/nekoroshell_backup_$TIMESTAMP.tar.gz"
    BACKUP_ITEMS=()
    CONFIGS=(btop cava fastfetch hypr hypremoji kitty rofi swaync systemd wallpapers wallust waybar wlogout themes)

    mkdir -p "$CONF_DIR"
    for conf in "${CONFIGS[@]}"; do
        if [[ -e "$CONF_DIR/$conf" ]]; then
            BACKUP_ITEMS+=("$conf")
        fi
    done

    if [[ ${#BACKUP_ITEMS[@]} -gt 0 ]]; then
        tar -czf "$BACKUP_ARCHIVE" -C "$CONF_DIR" "${BACKUP_ITEMS[@]}"
        echo -e "${GREEN}Created pre-update backup archive at: $BACKUP_ARCHIVE${NC}"
    else
        echo -e "${YELLOW}No existing configs found to backup. Proceeding...${NC}"
    fi

    echo -e "\n${BLUE}Downloading and extracting...${NC}"

    rm -rf "$TEMP_DIR"
    mkdir -p "$TEMP_DIR"
    curl -sL "$TARBALL_URL" | tar -xz -C "$TEMP_DIR" --strip-components=1

    if [[ ! -d "$TEMP_DIR/.config" ]]; then
        echo -e "${RED}Error: Extraction failed or invalid repository structure.${NC}"
        exit 1
    fi

    echo -e "${BLUE}Pre-processing downloaded files to match your system...${NC}"

    find "$TEMP_DIR/.config" -type f \( -name "*.conf" -o -name "*.json" -o -name "*.jsonc" -o -name "*.css" -o -name "*.rasi" -o -name "*.sh" \) -print0 2>/dev/null | xargs -0 -r sed -i "s|/home/nekorosys|$HOME|g"

    declare -a MONITOR_LIST
    if [[ -n "$HYPRLAND_INSTANCE_SIGNATURE:-" ]] && command -v hyprctl &> /dev/null; then
        mapfile -t MONITOR_LIST < <(hyprctl monitors | awk '/Monitor/ {print $2}')
    else
        for f in /sys/class/drm/*/status; do
            if grep -q "^connected$" "$f" 2>/dev/null; then
                monitor_name=$(basename "$(dirname "$f")" | sed -E 's/^card[0-9]+-//')
                [[ ! " ${MONITOR_LIST[*]} " =~ " ${monitor_name} " ]] && MONITOR_LIST+=("$monitor_name")
            fi
        done
    fi

    echo -e "\n${BLUE}Comparing configurations...${NC}"

    while IFS= read -r -u 3 new_file; do
        relative_path="${new_file#$TEMP_DIR/}"
        target_file="$HOME/$relative_path"
        target_dir=$(dirname "$target_file")

        if [[ ! -f "$target_file" ]]; then
            mkdir -p "$target_dir"
            cp "$new_file" "$target_file"
            echo -e "${GREEN}Added new file:${NC} $relative_path"
            continue
        fi

        if ! cmp -s "$new_file" "$target_file"; then
            prompt_merge "$new_file" "$target_file"
        fi
    done 3< <(find "$TEMP_DIR/.config" -type f)

    echo -e "\n${BLUE}Verifying user configuration sandbox...${NC}"

    USER_CONF_DIR="$CONF_DIR/hypr/user/configs"
    USER_SCRIPT_DIR="$CONF_DIR/hypr/user/scripts"
    TEMPLATE_DIR="$CONF_DIR/hypr/user/templates"

    mkdir -p "$USER_CONF_DIR"
    mkdir -p "$USER_SCRIPT_DIR"

    if [[ -d "$TEMPLATE_DIR" ]]; then
        for file in "$TEMPLATE_DIR"/*.conf; do
            [ -e "$file" ] || continue
            filename=$(basename "$file")
            if [ ! -f "$USER_CONF_DIR/$filename" ]; then
                cp "$file" "$USER_CONF_DIR/$filename"
                echo -e "  [${GREEN}New${NC}] Initialized missing user config: $filename"
            fi
        done
    fi

    if [ ! -f "$USER_SCRIPT_DIR/autostart.sh" ]; then
        echo "#!/bin/bash" > "$USER_SCRIPT_DIR/autostart.sh"
        echo "# Add your personal startup commands here" >> "$USER_SCRIPT_DIR/autostart.sh"
        chmod +x "$USER_SCRIPT_DIR/autostart.sh"
        echo -e "  [${GREEN}New${NC}] Initialized user autostart script."
    fi

    if [[ ${#MONITOR_LIST[@]} -gt 0 ]]; then
        PRIMARY_MONITOR=${MONITOR_LIST[0]}
        SECONDARY_MONITOR=${MONITOR_LIST[1]:-$PRIMARY_MONITOR}
        
        if [[ -d "$USER_CONF_DIR" ]]; then
            find "$USER_CONF_DIR" -type f -name "*.conf" -exec sed -i "s/__PRIMARY_MONITOR__/$PRIMARY_MONITOR/g" {} +
            if [[ ${#MONITOR_LIST[@]} -ge 2 ]]; then
                find "$USER_CONF_DIR" -type f -name "*.conf" -exec sed -i "s/__SECONDARY_MONITOR__/$SECONDARY_MONITOR/g" {} +
            else
                find "$USER_CONF_DIR" -type f -name "*.conf" -exec sed -i '/monitor=__SECONDARY_MONITOR__/s/^/#/' {} +
            fi
        fi
    fi

    echo -e "\n${BLUE}Scanning for and removing legacy root-level scripts...${NC}"

    for legacy_dir in "$HOME/.local/bin" "$HOME/bin"; do
        if [[ -d "$legacy_dir" ]]; then
            for new_script in "$TEMP_DIR/bin/"*; do
                if [[ -f "$new_script" ]]; then
                    script_name=$(basename "$new_script")
                    
                    if [[ -f "$legacy_dir/$script_name" ]]; then
                        echo -e "${YELLOW}Removing old script to prevent conflicts:${NC} $legacy_dir/$script_name"
                        rm -f "$legacy_dir/$script_name"
                    fi
                fi
            done
        fi
    done

    echo -e "\n${BLUE}Updating core scripts and binaries...${NC}"

    if [[ -d "$HOME/.local/bin/nekoroshell" ]]; then
        BIN_DIR="$HOME/.local/bin/nekoroshell"
    elif [[ -d "$HOME/bin/nekoroshell" ]]; then
        BIN_DIR="$HOME/bin/nekoroshell"
    else
        BIN_DIR="$HOME/.local/bin/nekoroshell"
        mkdir -p "$BIN_DIR"
    fi

    if [[ -d "$TEMP_DIR/bin" ]]; then
        for new_script in "$TEMP_DIR/bin/"*; do
            script_name=$(basename "$new_script")
            if [[ "$script_name" != "nekoroshell" ]]; then
                cp -r "$new_script" "$BIN_DIR/" 2>/dev/null
            fi
        done

        if [[ -f "$TEMP_DIR/bin/nekoroshell" ]]; then
            cp "$TEMP_DIR/bin/nekoroshell" "$BIN_DIR/nekoroshell.new"
            mv "$BIN_DIR/nekoroshell.new" "$BIN_DIR/nekoroshell"
        fi

        chmod +x "$BIN_DIR"/* 2>/dev/null
        echo -e "${GREEN}Successfully updated bash scripts in $BIN_DIR${NC}"
    fi

    echo -e "${BLUE}Recompiling C++ Daemons...${NC}"
    if ! command -v g++ &> /dev/null || ! command -v pkg-config &> /dev/null; then
        echo -e "${RED}Warning: g++ or pkg-config not found. Skipping C++ recompilation.${NC}"
    else
        REQUIRED_LIBS="wayland-client" 
        if ! pkg-config --exists $REQUIRED_LIBS; then
            echo -e "${RED}Warning: Missing development headers for $REQUIRED_LIBS. Skipping compilation.${NC}"
        else
            LIBS=$(pkg-config --cflags --libs $REQUIRED_LIBS)

            if [[ -f "$TEMP_DIR/src/navbar-hover.cpp" ]]; then
                g++ -O3 -o "$BIN_DIR/navbar-hover" "$TEMP_DIR/src/navbar-hover.cpp" $LIBS
                echo -e "  [${GREEN}OK${NC}] Compiled navbar-hover"
            fi
            
            if [[ -f "$TEMP_DIR/src/navbar-watcher.cpp" ]]; then
                g++ -O3 -o "$BIN_DIR/navbar-watcher" "$TEMP_DIR/src/navbar-watcher.cpp" $LIBS
                echo -e "  [${GREEN}OK${NC}] Compiled navbar-watcher"
            fi
            
            if [[ -f "$TEMP_DIR/src/hypr-nice.cpp" ]]; then
                g++ -O3 -o "$BIN_DIR/hypr-nice" "$TEMP_DIR/src/hypr-nice.cpp"
                echo -e "  [${GREEN}OK${NC}] Compiled hypr-nice"
            fi

            if [[ -f "$TEMP_DIR/src/eject-forbidden.cpp" ]]; then
                g++ -O3 -o "$BIN_DIR/eject-forbidden" "$TEMP_DIR/src/eject-forbidden.cpp"
                echo -e "  [${GREEN}OK${NC}] Compiled eject-forbidden"
            fi
        fi
    fi

    rm -rf "$TEMP_DIR"

    if command -v hyprctl >/dev/null 2>&1; then
        hyprctl reload >/dev/null 2>&1
    fi

    echo -e "${GREEN}Upgrade to $LATEST_TAG complete!${NC}"
}

do_create_skin() {
    echo -e "${BLUE}NeKoRoSHELL Skin Template Generator${NC}\n"
    echo -e "Which feature do you want to create a skin for?"
    echo "1) Navbar (waybar)"
    echo "2) Launcher (rofi)"
    echo "3) Lockscreen (hyprlock)"
    echo "4) Panel (swaync)"
    echo "5) Power (wlogout)"
    read -r -p "Select option (1-5): " feature_opt

    local target_dir=""
    local required_files=()
    local feature_name=""

    case "$feature_opt" in
        1) feature_name="navbar"; target_dir="$CONF_DIR/waybar/skins"; required_files=("style.css" "layout.jsonc" "navbar-hover.conf") ;;
        2) feature_name="launcher"; target_dir="$CONF_DIR/rofi/skins"; required_files=("config.rasi" "style.rasi") ;;
        3) feature_name="lockscreen"; target_dir="$CONF_DIR/hypr/hyprlock/skins"; ;;
        4) feature_name="panel"; target_dir="$CONF_DIR/swaync/skins"; required_files=("style.css" "config.json") ;;
        5) feature_name="power"; target_dir="$CONF_DIR/wlogout/skins"; required_files=("style.css" "layout") ;;
        *) echo -e "${RED}Invalid option.${NC}"; exit 1 ;;
    esac

    read -r -p "Enter the name for your new $feature_name skin: " skin_name
    if [[ -z "$skin_name" ]]; then echo -e "${RED}Skin name cannot be empty.${NC}"; exit 1; fi

    skin_name="${skin_name// /_}"

    local skin_path="$target_dir/$skin_name"
    if [[ -d "$skin_path" ]]; then
        echo -e "${RED}Error: Skin '$skin_name' already exists at $skin_path${NC}"
        exit 1
    fi

    mkdir -p "$skin_path"
    
    if [[ "$feature_name" == "lockscreen" ]]; then
        touch "$skin_path/$skin_name.conf"
        echo "# Hyprlock config for $skin_name" > "$skin_path/$skin_name.conf"
    else
        for req_file in "${required_files[@]}"; do
            touch "$skin_path/$req_file"
            
            if [[ "$req_file" == *.css || "$req_file" == *.rasi ]]; then
                echo "/* $req_file for $skin_name */" > "$skin_path/$req_file"
            elif [[ "$req_file" == *.json || "$req_file" == *.jsonc ]]; then
                echo "{}" > "$skin_path/$req_file"
            fi
        done

        touch "$skin_path/layerrule.conf"
    fi

    echo -e "\n${GREEN}Success!${NC} Created empty template for '$skin_name' in:"
    echo -e "${YELLOW}$skin_path${NC}"
    echo "You can now edit these files to build your skin."
}

do_create_theme() {
    echo -e "${BLUE}NeKoRoSHELL Theme Generator${NC}\n"
    read -r -p "Enter the name for your new theme: " theme_name
    if [[ -z "$theme_name" ]]; then echo -e "${RED}Theme name cannot be empty.${NC}"; exit 1; fi
    theme_name="${theme_name// /_}"

    local theme_dir="$CONF_DIR/themes/$theme_name"
    if [[ -d "$theme_dir" ]]; then
        echo -e "${RED}Error: Theme '$theme_name' already exists.${NC}"
        exit 1
    fi

    echo -e "\n${YELLOW}Specify the skins for this theme (leave blank to default to 'legacy').${NC}"
    
    read -r -p "Wallpaper file (e.g. 'image.png', or 'random'): " t_wall
    t_wall=${t_wall:-random}

    read -r -p "Navbar skin: " t_nav
    t_nav=${t_nav:-legacy}

    read -r -p "Launcher skin: " t_launch
    t_launch=${t_launch:-legacy}

    read -r -p "Lockscreen layout: " t_lock
    t_lock=${t_lock:-legacy}

    read -r -p "Panel skin: " t_panel
    t_panel=${t_panel:-legacy}

    read -r -p "Power options skin: " t_power
    t_power=${t_power:-legacy}

    mkdir -p "$theme_dir"
    local script_path="$theme_dir/$theme_name.sh"

    cat << 'EOF' > "$script_path"
#!/bin/bash
# Auto-generated theme script by NeKoRoSHELL

CONF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"

WALLPAPER="VAR_WALL"
NAVBAR="VAR_NAV"
LAUNCHER="VAR_LAUNCH"
LOCKSCREEN="VAR_LOCK"
PANEL="VAR_PANEL"
POWER="VAR_POWER"

missing=0

if [[ "$WALLPAPER" != "random" && ! -f "$CONF_DIR/wallpapers/$WALLPAPER" ]]; then
    echo "Error: Wallpaper '$WALLPAPER' not found in ~/.config/wallpapers/"
    missing=1
fi
if [[ ! -d "$CONF_DIR/waybar/skins/$NAVBAR" ]]; then
    echo "Error: Navbar skin '$NAVBAR' not found."
    missing=1
fi
if [[ ! -d "$CONF_DIR/rofi/skins/$LAUNCHER" ]]; then
    echo "Error: Launcher skin '$LAUNCHER' not found."
    missing=1
fi
if [[ ! -d "$CONF_DIR/hypr/hyprlock/skins/$LOCKSCREEN" ]]; then
    echo "Error: Lockscreen layout '$LOCKSCREEN' not found."
    missing=1
fi
if [[ ! -d "$CONF_DIR/swaync/skins/$PANEL" ]]; then
    echo "Error: Panel skin '$PANEL' not found."
    missing=1
fi
if [[ ! -d "$CONF_DIR/wlogout/skins/$POWER" ]]; then
    echo "Error: Power options skin '$POWER' not found."
    missing=1
fi

if [ $missing -eq 1 ]; then
    echo "Theme validation failed. Please create the missing skins or edit this theme script."
    command -v makenotif >/dev/null && makenotif customize dialog-error "Theme Error" "Missing skins for theme." true
    exit 1
fi

quick-theme "$WALLPAPER" "$NAVBAR" "$LAUNCHER" "$LOCKSCREEN" "$PANEL" "$POWER"
EOF

    sed -i "s/VAR_WALL/$t_wall/" "$script_path"
    sed -i "s/VAR_NAV/$t_nav/" "$script_path"
    sed -i "s/VAR_LAUNCH/$t_launch/" "$script_path"
    sed -i "s/VAR_LOCK/$t_lock/" "$script_path"
    sed -i "s/VAR_PANEL/$t_panel/" "$script_path"
    sed -i "s/VAR_POWER/$t_power/" "$script_path"

    chmod +x "$script_path"

    echo -e "\n${GREEN}Success!${NC} Theme '$theme_name' script created at:"
    echo -e "${YELLOW}$script_path${NC}"
    echo "You can apply it via the customizer GUI tool or by running the script directly."
}

if [ $# -eq 0 ]; then
    usage
fi

case "$1" in
    update|upgrade)
        do_update
        ;;
    uninstall|remove)
        do_uninstall
        ;;
    *)
        usage
        ;;
esac
