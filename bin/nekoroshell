#!/usr/bin/env bash
set -euo pipefail

readonly GREEN='\033[0;32m'
readonly BLUE='\033[0;34m'
readonly YELLOW='\033[1;33m'
readonly RED='\033[0;31m'
readonly NC='\033[0m'

readonly REPO="nekorosys/nekoroshell"
readonly TEMP_DIR="/tmp/nekoroshell_upgrade"
readonly CONF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
readonly CORE_CONFIGS=(btop cava fastfetch hypr hypremoji kitty rofi swaync themes wallpapers wallust waybar wlogout)

log_info()    { echo -e "${BLUE}$1${NC}"; }
log_success() { echo -e "  [âœ”] ${GREEN}$1${NC}"; }
log_warn()    { echo -e "  [!] ${YELLOW}$1${NC}"; }
log_error()   { echo -e "${RED}$1${NC}"; }

usage() {
    echo -e "${BLUE}NeKoRoSHELL Management Utility${NC}\n"
    echo -e "Usage: nekoroshell [COMMAND]\n"
    echo -e "Commands:"
    echo -e "  ${GREEN}update${NC}        Fetch and apply the latest NeKoRoSHELL release."
    echo -e "  ${GREEN}create-skin${NC}   Create a new empty skin template for a specific feature."
    echo -e "  ${GREEN}create-theme${NC}  Create a new theme script bundle from existing skins."
    echo -e "  ${RED}uninstall${NC}     Remove all NeKoRoSHELL configurations and scripts.\n"
    exit 1
}

clean_shell_rc() {
    local shell_rc="$1"
    if [[ -f "$shell_rc" ]] && grep -q "# --- NeKoRoSHELL START ---" "$shell_rc"; then
        sed -i '/# --- NeKoRoSHELL START ---/,/# --- NeKoRoSHELL END ---/d' "$shell_rc"
        log_success "Cleaned $shell_rc"
    fi
}

prompt_merge() {
    local new_file="$1"
    local target_file="$2"
    local relative_path="${target_file#$HOME/}"

    while true; do
        echo -e "\n${YELLOW}Conflict detected in: ${NC}$relative_path"
        echo -ne "Action: [${GREEN}o${NC}]verwrite, [${RED}k${NC}]eep current, [${BLUE}v${NC}]iew diff, [${YELLOW}m${NC}]erge? "
        read -r -n 1 choice 
        echo ""
        
        case "${choice,,}" in
            o) cp "$new_file" "$target_file"; log_success "Overwritten."; return ;;
            k) log_warn "Kept current version."; return ;;
            v) diff --color=always -u "$target_file" "$new_file" | less -R || true ;;
            m) 
                local merge_tool="${MERGE_TOOL:-vimdiff}"
                if command -v "$merge_tool" &> /dev/null; then
                    log_info "Opening merge review in $merge_tool..."
                    if [ "$merge_tool" = "code" ]; then
                        code --wait --diff "$target_file" "$new_file" || true
                    else
                        "$merge_tool" "$target_file" "$new_file" || true
                    fi
                    echo -e "${YELLOW}Merge tool closed. Press [k] to keep your changes, or choose another action.${NC}"
                else
                    log_warn "$merge_tool not found. Falling back to diff3..."
                    if diff3 -m "$target_file" "$target_file" "$new_file" > "${target_file}.tmp_merge"; then
                        mv "${target_file}.tmp_merge" "$target_file"
                        log_success "Merged cleanly using diff3."
                        return
                    else
                        log_warn "Merge conflicts found! Opening in your standard editor to resolve manually..."
                        local user_editor=${VISUAL:-${EDITOR:-nano}}
                        command -v "$user_editor" >/dev/null 2>&1 || user_editor="vi"
                        
                        "$user_editor" "${target_file}.tmp_merge" || true
                        mv "${target_file}.tmp_merge" "$target_file"
                        echo -e "${YELLOW}Editor closed. Press [k] to keep your changes, or choose another action.${NC}"
                    fi
                fi
                ;;
            *) log_error "Invalid choice. Please press o, k, v, or m." ;;
        esac
    done
}

uninstall() {
    log_info "# ======================================================= #"
    log_info "#              NeKoRoSHELL Uninstallation Utility         #"
    log_info "# ======================================================= #\n"

    log_warn "WARNING: This script will remove all NeKoRoSHELL configurations, scripts, and services."
    echo -e "System packages (Hyprland, Waybar, etc.) will NOT be uninstalled."
    echo -e "If backups of your original configs exist, this script will attempt to restore them.\n"

    echo -ne "${RED}Are you absolutely sure you want to proceed? (y/n): ${NC}"
    read -r confirm
    [[ ! "$confirm" =~ ^[Yy]$ ]] && { log_success "Uninstallation aborted."; exit 0; }

    log_info "\nStopping and disabling NeKoRoSHELL services..."
    if command -v systemctl >/dev/null 2>&1; then
        for svc in waybar swaync navbar navbar-hover navbar-watcher; do
            systemctl --user stop "$svc.service" 2>/dev/null || true
            systemctl --user disable "$svc.service" 2>/dev/null || true
        done
        rm -f "$CONF_DIR/systemd/user/navbar"*
        systemctl --user daemon-reload
        log_success "Services stopped and removed."
    fi

    log_info "\nRemoving NeKoRoSHELL configs and restoring backups..."
    for conf in "${CORE_CONFIGS[@]}"; do
        if [[ -d "$CONF_DIR/$conf" ]]; then
            rm -rf "$CONF_DIR/$conf"
            echo -e "  Removed ${YELLOW}$conf${NC} configuration."
        fi
    done

    local latest_backup=$(ls -1 "$HOME/nekoroshell_backup_"*.tar.gz 2>/dev/null | sort -V | tail -n 1)
    if [[ -n "$latest_backup" ]]; then
        log_info "\nRestoring from backup archive: $(basename "$latest_backup")..."
        tar -xzf "$latest_backup" -C "$CONF_DIR"
        log_success "Configurations recovered from tarball."
    else
        log_warn "No tarball backup found to restore."
    fi

    log_info "\nCleaning up NeKoRoSHELL scripts and binaries..."
    for bin_dir in "$HOME/.local/bin/nekoroshell" "$HOME/bin/nekoroshell"; do
        if [[ -d "$bin_dir" ]]; then
            rm -rf "$bin_dir"
            echo -e "  Removed directory: ${YELLOW}$bin_dir${NC}"
        fi
    done

    for f in .p10k.zsh .face.icon change-avatar.sh; do
        if [[ -f "$HOME/$f" ]]; then
            rm -f "$HOME/$f"
            echo -e "  Removed file: ${YELLOW}$f${NC}"
        fi
    done

    log_info "\nRemoving injected NeKoRoSHELL path variables from shell profiles..."
    clean_shell_rc "$HOME/.bashrc"
    clean_shell_rc "$HOME/.zshrc"
    
    echo -e "\n${GREEN}Uninstallation complete!${NC}"
    echo -e "You may need to log out and log back in, or restart your computer, for all changes to fully take effect."
}

update() {
    log_info "# ======================================================= #"
    log_info "#              NeKoRoSHELL Upgrade Utility                #"
    log_info "# ======================================================= #\n"

    log_info "Fetching latest release info from GitHub..."
    local release_json=$(curl -s "https://api.github.com/repos/$REPO/releases/latest")
    local tag=$(echo "$release_json" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
    local tar_url=$(echo "$release_json" | grep '"tarball_url":' | sed -E 's/.*"([^"]+)".*/\1/')

    [[ -z "$tag" || -z "$tar_url" ]] && { log_error "Error: Could not fetch release data. Are you connected to the internet?"; exit 1; }
    
    log_success "Latest release found: $tag\n"
    
    echo -ne "${YELLOW}Do you want to proceed with the upgrade to $tag? (y/n): ${NC}"
    read -r confirm
    [[ ! "$confirm" =~ ^[Yy]$ ]] && { log_error "Upgrade aborted by user."; exit 0; }

    log_info "\nCreating backup before update..."
    local backup_archive="$HOME/nekoroshell_backup_$(date +%Y%m%d_%H%M%S).tar.gz"
    local backup_items=()
    mkdir -p "$CONF_DIR"

    for conf in "${CORE_CONFIGS[@]}"; do
        [[ -e "$CONF_DIR/$conf" ]] && backup_items+=("$conf")
    done

    if [[ ${#backup_items[@]} -gt 0 ]]; then
        tar -czf "$backup_archive" -C "$CONF_DIR" "${backup_items[@]}"
        log_success "Created pre-update backup archive at: $backup_archive"
    else
        log_warn "No existing configs found to backup. Proceeding..."
    fi

    log_info "\nDownloading and extracting..."
    rm -rf "$TEMP_DIR" && mkdir -p "$TEMP_DIR"
    curl -sL "$tar_url" | tar -xz -C "$TEMP_DIR" --strip-components=1

    [[ ! -d "$TEMP_DIR/.config" ]] && { log_error "Error: Extraction failed or invalid repository structure."; exit 1; }

    log_info "Pre-processing downloaded files to match your system..."
    local search="/home/nekorosys"
    local rep_escaped=$(echo "$HOME" | sed 's/|/\\|/g; s/\\/\\\\/g')
    find "$TEMP_DIR/.config" -type f \( -name "*.config" -o -name "*.css" -o -name "*.rasi" -o -name "*.conf" -o -name "*.sh" -o -name "*.json" -o -name "*.jsonc" -o -name "*.lua" -o -name "*.py" -o -name "*.yaml" \) -exec grep -l "$search" {} + 2>/dev/null | xargs -r sed -i "s|$search|$rep_escaped|g" || true

    log_info "\nComparing configurations..."
    while IFS= read -r -u 3 new_file; do
        local rel_path="${new_file#$TEMP_DIR/}"
        local tgt_file="$HOME/$rel_path"
        
        if [[ ! -f "$tgt_file" ]]; then
            mkdir -p "$(dirname "$tgt_file")"
            cp "$new_file" "$tgt_file"
            echo -e "${GREEN}Added new file:${NC} $rel_path"
        elif ! cmp -s "$new_file" "$tgt_file"; then
            prompt_merge "$new_file" "$tgt_file"
        fi
    done 3< <(find "$TEMP_DIR/.config" -type f)

    log_info "\nUpdating core scripts and binaries..."
    local base_bin_dir
    if [[ -d "$HOME/.local/bin" ]]; then
        base_bin_dir="$HOME/.local/bin"
    else
        base_bin_dir="$HOME/bin"
    fi
    local bin_dir="$base_bin_dir/nekoroshell"
    mkdir -p "$bin_dir"

    if [[ -d "$TEMP_DIR/bin" ]]; then
        cp -r "$TEMP_DIR/bin/"* "$bin_dir/" 2>/dev/null || true
        chmod +x "$bin_dir"/* 2>/dev/null || true
        log_success "Successfully updated bash scripts in $bin_dir"
    fi

    log_info "\nRecompiling C++ Daemons via Make..."
    if ! command -v make &> /dev/null || ! command -v g++ &> /dev/null || ! command -v pkg-config &> /dev/null; then
        log_warn "make, g++, or pkg-config not found. Skipping C++ recompilation."
    else
        if ! pkg-config --exists "wayland-client"; then
            log_warn "Missing development headers for wayland-client. Skipping compilation."
        else
            pushd "$TEMP_DIR" >/dev/null
            if make clean all; then
                log_success "Successfully compiled C++ daemons."
                
                local copy_failed=0
                for compiled_file in build/*; do
                    if [[ -f "$compiled_file" ]]; then
                        rm -f "$bin_dir/$(basename "$compiled_file")" 2>/dev/null || true
                        cp "$compiled_file" "$bin_dir/" || copy_failed=1
                    fi
                done
                
                [[ $copy_failed -eq 1 ]] && log_warn "Failed to copy some binaries."
            else
                log_error "Warning: Compilation failed."
            fi
            popd >/dev/null
        fi
    fi

    rm -rf "$TEMP_DIR"

    command -v hyprctl >/dev/null 2>&1 && hyprctl reload >/dev/null 2>&1

    if [[ -x "$CONF_DIR/hypr/user/hooks/post-update.sh" ]]; then
        log_info "\nExecuting user post-update hook..."
        "$CONF_DIR/hypr/user/hooks/post-update.sh" || log_error "Warning: post-update hook failed."
    fi
    
    echo -e "\n${GREEN}Upgrade to $tag complete!${NC}"
}

create_skin() {
    echo -e "${BLUE}NeKoRoSHELL Skin Template Generator${NC}\n"
    echo -e "Which feature do you want to create a skin for?"
    echo "1) Navbar (waybar)"
    echo "2) Launcher (rofi)"
    echo "3) Lockscreen (hyprlock)"
    echo "4) Panel (swaync)"
    echo "5) Power (wlogout)"
    echo "6) Windows (hyprland)"
    read -r -p "Select option (1-6): " feature_opt

    local target_dir=""
    local required_files=()
    local feature_name=""

    case "$feature_opt" in
        1) feature_name="navbar"; target_dir="$CONF_DIR/waybar/skins"; required_files=("style.css" "layout.jsonc" "navbar-hover.conf" "layerrule.conf") ;;
        2) feature_name="launcher"; target_dir="$CONF_DIR/rofi/skins"; required_files=("config.rasi" "style.rasi" "layerrule.conf") ;;
        3) feature_name="lockscreen"; target_dir="$CONF_DIR/hypr/hyprlock/skins"; ;;
        4) feature_name="panel"; target_dir="$CONF_DIR/swaync/skins"; required_files=("style.css" "config.json" "layerrule.conf") ;;
        5) feature_name="power"; target_dir="$CONF_DIR/wlogout/skins"; required_files=("style.css" "layout") ;;
        6) feature_name="windows"; target_dir="$CONF_DIR/hypr/user/skins"; required_files=("appearance.conf" "animations.conf") ;;
        *) echo -e "${RED}Invalid option.${NC}"; exit 1 ;;
    esac

    read -r -p "Enter the name for your new $feature_name skin: " skin_name
    if [[ -z "$skin_name" ]]; then echo -e "${RED}Skin name cannot be empty.${NC}"; exit 1; fi

    skin_name="${skin_name// /_}"

    local skin_path="$target_dir/$skin_name"
    if [[ -d "$skin_path" ]]; then
        echo -e "${RED}Error: Skin '$skin_name' already exists at $skin_path${NC}"
        exit 1
    fi

    mkdir -p "$skin_path"
    
    if [[ "$feature_name" == "lockscreen" ]]; then
        touch "$skin_path/$skin_name.conf"
        echo "# Hyprlock config for $skin_name" > "$skin_path/$skin_name.conf"
    else
        for req_file in "${required_files[@]}"; do
            touch "$skin_path/$req_file"
            
            if [[ "$req_file" == *.css || "$req_file" == *.rasi ]]; then
                echo "/* $req_file for $skin_name */" > "$skin_path/$req_file"
            elif [[ "$req_file" == *.json || "$req_file" == *.jsonc ]]; then
                echo "{}" > "$skin_path/$req_file"
            elif [[ "$feature_name" == "windows" ]]; then
                echo "# Hyprland $req_file skin: $skin_name" > "$skin_path/$req_file"
            elif [[ "$req_file" == layerrule.conf ]]; then
                echo "# Hyprland layer rules (blur window, etc.)" > "$skin_path/$req_file"
            fi
        done
    fi

    echo -e "\n${GREEN}Success!${NC} Created empty template for '$skin_name' in:"
    echo -e "${YELLOW}$skin_path${NC}"
    echo "You can now edit these files to build your skin."
}

create_theme() {
    echo -e "${BLUE}NeKoRoSHELL Theme Generator${NC}\n"
    read -r -p "Enter the name for your new theme: " theme_name
    if [[ -z "$theme_name" ]]; then echo -e "${RED}Theme name cannot be empty.${NC}"; exit 1; fi
    theme_name="${theme_name// /_}"

    local theme_dir="$CONF_DIR/themes/$theme_name"
    if [[ -d "$theme_dir" ]]; then
        echo -e "${RED}Error: Theme '$theme_name' already exists.${NC}"
        exit 1
    fi

    echo -e "\n${YELLOW}Specify the skins for this theme (leave blank to default to 'legacy').${NC}"
    
    read -r -p "Wallpaper file (e.g. 'image.png', or 'random'): " t_wall
    t_wall=${t_wall:-random}

    read -r -p "Navbar skin: " t_nav
    t_nav=${t_nav:-legacy}

    read -r -p "Launcher skin: " t_launch
    t_launch=${t_launch:-legacy}

    read -r -p "Lockscreen layout: " t_lock
    t_lock=${t_lock:-legacy}

    read -r -p "Panel skin: " t_panel
    t_panel=${t_panel:-legacy}

    read -r -p "Power options skin: " t_power
    t_power=${t_power:-legacy}

    read -r -p "Windows skin: " t_windows
    t_windows=${t_windows:-legacy}

    mkdir -p "$theme_dir"
    local script_path="$theme_dir/$theme_name.sh"

    cat << 'EOF' > "$script_path"
#!/bin/bash
# Auto-generated theme script by NeKoRoSHELL

CONF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"

WALLPAPER="VAR_WALL"
NAVBAR="VAR_NAV"
LAUNCHER="VAR_LAUNCH"
LOCKSCREEN="VAR_LOCK"
PANEL="VAR_PANEL"
POWER="VAR_POWER"
WINDOWS="VAR_WINDOWS"

missing=0

if [[ "$WALLPAPER" != "random" && ! -f "$CONF_DIR/wallpapers/$WALLPAPER" ]]; then
    echo "Error: Wallpaper '$WALLPAPER' not found in ~/.config/wallpapers/"
    missing=1
fi
if [[ ! -d "$CONF_DIR/waybar/skins/$NAVBAR" ]]; then
    echo "Error: Navbar skin '$NAVBAR' not found."
    missing=1
fi
if [[ ! -d "$CONF_DIR/rofi/skins/$LAUNCHER" ]]; then
    echo "Error: Launcher skin '$LAUNCHER' not found."
    missing=1
fi
if [[ ! -d "$CONF_DIR/hypr/hyprlock/skins/$LOCKSCREEN" ]]; then
    echo "Error: Lockscreen layout '$LOCKSCREEN' not found."
    missing=1
fi
if [[ ! -d "$CONF_DIR/swaync/skins/$PANEL" ]]; then
    echo "Error: Panel skin '$PANEL' not found."
    missing=1
fi
if [[ ! -d "$CONF_DIR/wlogout/skins/$POWER" ]]; then
    echo "Error: Power options skin '$POWER' not found."
    missing=1
fi
if [[ ! -d "$CONF_DIR/hypr/user/skins/$WINDOWS" ]]; then
    echo "Error: Windows skin '$WINDOWS' not found."
    missing=1
fi

if [ $missing -eq 1 ]; then
    echo "Theme validation failed. Please create the missing skins or edit this theme script."
    command -v makenotif >/dev/null && makenotif customize dialog-error "Theme Error" "Missing skins for theme."
    true
    exit 1
fi

quick-theme "$WALLPAPER" "$NAVBAR" "$LAUNCHER" "$LOCKSCREEN" "$PANEL" "$POWER" "$WINDOWS"
EOF

    sed -i "s/VAR_WALL/$t_wall/" "$script_path"
    sed -i "s/VAR_NAV/$t_nav/" "$script_path"
    sed -i "s/VAR_LAUNCH/$t_launch/" "$script_path"
    sed -i "s/VAR_LOCK/$t_lock/" "$script_path"
    sed -i "s/VAR_PANEL/$t_panel/" "$script_path"
    sed -i "s/VAR_POWER/$t_power/" "$script_path"
    sed -i "s/VAR_WINDOWS/$t_windows/" "$script_path"

    chmod +x "$script_path"

    echo -e "\n${GREEN}Success!${NC} Theme '$theme_name' script created at:"
    echo -e "${YELLOW}$script_path${NC}"
    echo "You can apply it via the customizer GUI tool or by running the script directly."
}

main() {
    [[ $# -eq 0 ]] && usage
    
    case "$1" in
        update|upgrade)   update ;;
        uninstall|remove) uninstall ;;
        create-skin)      create_skin ;; 
        create-theme)     create_theme ;;
        *)                usage ;;
    esac
}

main "$@"
