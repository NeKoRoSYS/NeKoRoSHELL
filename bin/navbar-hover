#!/bin/bash

HOVER_CONF="$HOME/.cache/navbar-hover.conf"
STATE="hidden"

read_config() {
    # Default values
    ACTIVATE_SIZE=10   # How close to the edge to show the bar
    DEACTIVATE_SIZE=40 # How far away to move to hide the bar
    BAR_POSITION="top"
    
    # Override defaults if config exists
    [ -f "$HOVER_CONF" ] && source "$HOVER_CONF"
}

update_monitors() {
    mapfile -t MONITORS < <(hyprctl monitors -j | jq -r '.[] | "\(.x) \(.y) \(.width) \(.height)"')
}

# Initial setup
if ! pgrep -x "waybar" >/dev/null; then
    waybar &
    sleep 0.5
fi

pkill -SIGUSR1 waybar
read_config
update_monitors

CYCLE_COUNT=0
while true; do
    ((CYCLE_COUNT++))
    if [ "$CYCLE_COUNT" -ge 50 ]; then
        read_config
        update_monitors
        CYCLE_COUNT=0
    fi

    IFS=', ' read -r CX CY < <(hyprctl cursorpos)

    if [ "$STATE" = "hidden" ]; then
        CURRENT_THRESH=$ACTIVATE_SIZE
    else
        CURRENT_THRESH=$DEACTIVATE_SIZE
    fi

    IS_HOVERING=0
    for mon in "${MONITORS[@]}"; do
        read -r mx my mw mh <<< "$mon"
        
        case "$BAR_POSITION" in
            "top")    (( CX >= mx && CX < mx + mw && CY >= my && CY <= my + CURRENT_THRESH )) && IS_HOVERING=1 ;;
            "bottom") (( CX >= mx && CX < mx + mw && CY >= my + mh - CURRENT_THRESH && CY <= my + mh )) && IS_HOVERING=1 ;;
            "left")   (( CX >= mx && CX <= mx + CURRENT_THRESH && CY >= my && CY < my + mh )) && IS_HOVERING=1 ;;
            "right")  (( CX >= mx + mw - CURRENT_THRESH && CX <= mx + mw && CY >= my && CY < my + mh )) && IS_HOVERING=1 ;;
        esac
        [ "$IS_HOVERING" -eq 1 ] && break
    done

    if [ "$IS_HOVERING" -eq 1 ] && [ "$STATE" = "hidden" ]; then
        pkill -SIGUSR1 waybar
        STATE="visible"
    elif [ "$IS_HOVERING" -eq 0 ] && [ "$STATE" = "visible" ]; then
        pkill -SIGUSR1 waybar
        STATE="hidden"
    fi

    sleep 0.1
done
