#!/usr/bin/env bash

set -euo pipefail

readonly WARNING_CSS="/* WARNING: THIS FILE IS AUTO-GENERATED BY NEKOROSHELL. DO NOT EDIT DIRECTLY.\n   EDIT THE SOURCE SKIN TEMPLATE INSTEAD. */\n"
readonly WARNING_JSONC="// WARNING: THIS FILE IS AUTO-GENERATED BY NEKOROSHELL. DO NOT EDIT DIRECTLY.\n// EDIT THE SOURCE SKIN TEMPLATE INSTEAD.\n"
readonly WARNING_CONF="# WARNING: THIS FILE IS AUTO-GENERATED BY NEKOROSHELL. DO NOT EDIT DIRECTLY.\n# EDIT THE SOURCE SKIN TEMPLATE INSTEAD.\n"

readonly CONF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}"
readonly CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/nekoroshell"
readonly NAVBAR_MODE_FILE="$CACHE_DIR/navbar_mode"
readonly NAVBAR_HOVER_CONF="$CACHE_DIR/navbar-hover.conf"
readonly HYPR_RULES="$CONF_DIR/hypr/user/configs/windowrules.conf"

MANAGEMENT_MODE=$(cat "$NAVBAR_MODE_FILE" 2>/dev/null || echo "static")

check_user_mod() {
    local file="$1"
    if [ -f "$file" ] && [ -f "$file.sum" ]; then
        local current_sum=$(md5sum "$file" | cut -d' ' -f1)
        local stored_sum=$(cat "$file.sum")
        if [ "$current_sum" != "$stored_sum" ]; then
            local backup="${file}.user_bak_$(date +%Y%m%d_%H%M%S)"
            echo "User modification detected. Backing up $(basename "$file") to $(basename "$backup")"
            makenotif customize dialog-warning "Config Modified" "Manual edits to $(basename "$file") backed up." false
            cp "$file" "$backup"
        fi
    fi
}

save_hash() {
    local file="$1"
    md5sum "$file" | cut -d' ' -f1 > "$file.sum"
}

apply_ui_skin() {
    local feature="$1"
    local choice="$2"
    local name icon msg dir config style req_files

    case "$feature" in
        launcher)
            name="Launcher" icon="preferences-desktop-theme" msg="Select a Launcher skin."
            dir="$CONF_DIR/rofi/skins"
            config="$CONF_DIR/rofi/config.rasi"
            req_files=("config.rasi" "style.rasi")
            ;;
        panel)
            name="Control Centre" icon="preferences-desktop-theme" msg="Select Control Centre style."
            dir="$CONF_DIR/swaync/skins"
            config="$CONF_DIR/swaync/config.json"
            style="$CONF_DIR/swaync/style.css"
            req_files=("style.css" "config.json")
            ;;
        navbar)
            name="Navbar" icon="preferences-desktop-theme" msg="Select a Navbar skin."
            dir="$CONF_DIR/waybar/skins"
            config="$CONF_DIR/waybar/config.jsonc"
            style="$CONF_DIR/waybar/style.css"
            req_files=("style.css" "layout.jsonc" "navbar-hover.conf")
            ;;
        power)
            name="Power Options" icon="preferences-desktop-theme" msg="Select a Power Options layout."
            dir="$CONF_DIR/wlogout/skins"
            config="$CONF_DIR/wlogout/layout"
            style="$CONF_DIR/wlogout/style.css"
            req_files=("style.css" "layout")
            ;;
        windows)
            name="Windows" icon="preferences-desktop-theme" msg="Select a Windows skin."
            dir="$CONF_DIR/hypr/user/skins"
            req_files=("appearance.conf" "animations.conf")
            ;;
    esac

    if [ -z "$choice" ]; then
        makenotif customize "$icon" "$name" "$msg" true
        choice=$(ls "$dir" | rofi -dmenu -p "Select $name Skin")
    fi

    [ -z "$choice" ] && exit 0

    local path_skin="$dir/$choice"

    if [ ! -d "$path_skin" ]; then
        echo "Error: Skin '$choice' not found in $dir"
        exit 1
    fi

    for req_file in "${req_files[@]}"; do
        if [ ! -f "$path_skin/$req_file" ]; then
            makenotif customize dialog-error "$name Error" "Skin '$choice' is missing required file: $req_file" true
            echo "Error: Skin '$choice' missing $req_file. Aborting."
            exit 1
        fi
    done

    sed -i "\|^source = $dir/|d" "$HYPR_RULES"
    if [[ -f "$path_skin/layerrule.conf" ]]; then
        echo "source = $path_skin/layerrule.conf" >> "$HYPR_RULES"
    fi

    case "$feature" in
        launcher)
            check_user_mod "$config"
            echo -e "${WARNING_CSS}@import \"$path_skin/config.rasi\"\n@import \"$path_skin/style.rasi\"" > "$config"
            save_hash "$config"
            ;;
        panel)
            check_user_mod "$style"
            check_user_mod "$config"
            echo -e "${WARNING_CSS}@import \"$path_skin/style.css\";" > "$style"
            cp "$path_skin/config.json" "$config" || true
            save_hash "$style"
            save_hash "$config"
            swaync-client -R
            swaync-client -rs
            ;;
        navbar)
            check_user_mod "$style"
            check_user_mod "$config"
            echo -e "${WARNING_CSS}@import \"$path_skin/style.css\";" > "$style"
            echo -e "${WARNING_JSONC}{ \"include\": [ \"$path_skin/layout.jsonc\" ] }" > "$config"
            cp "$path_skin/navbar-hover.conf" "$NAVBAR_HOVER_CONF"
            save_hash "$style"
            save_hash "$config"

            killall -q navbar-hover navbar-watcher 2>/dev/null || true
            killall -q waybar 2>/dev/null || true
            sleep 0.2

            if [ "$MANAGEMENT_MODE" = "static" ]; then
                waybar &
            elif [ "$MANAGEMENT_MODE" = "hover" ]; then
                navbar-hover &
            else
                navbar-watcher &
            fi
            ;;
        power)
            check_user_mod "$style"
            check_user_mod "$config"
            echo -e "${WARNING_CSS}@import \"$path_skin/style.css\";" > "$style"
            cp "$path_skin/layout" "$config"
            save_hash "$style"
            save_hash "$config"
            ;;
        windows)
            local app_conf="$CONF_DIR/hypr/user/configs/appearance.conf"
            local anim_conf="$CONF_DIR/hypr/user/configs/animations.conf"
            
            check_user_mod "$app_conf"
            check_user_mod "$anim_conf"
            
            echo -e "${WARNING_CONF}" > "$app_conf"
            cat "$path_skin/appearance.conf" >> "$app_conf"
            
            echo -e "${WARNING_CONF}" > "$anim_conf"
            cat "$path_skin/animations.conf" >> "$anim_conf"
            
            save_hash "$app_conf"
            save_hash "$anim_conf"
            
            if command -v hyprctl >/dev/null 2>&1; then
                hyprctl reload >/dev/null 2>&1
            fi
            ;;
    esac

    makenotif customize "$icon" "$name" "Skin changed to: $choice" true
}

CMD_FEATURE="${1:-}"
CMD_CHOICE="${2:-}"

pkill -x rofi || true

theme="Select Theme"
wallpaper="Select Wallpaper"
navbar="Select Navbar Skin"
launcher="Select Launcher Skin"
lockscreen="Select Lockscreen Layout"
panel="Select Control Centre Layout"
power="Select Power Options Layout"
windows="Select Windows Skin"
OPTIONS="$theme\n$wallpaper\n$navbar\n$launcher\n$lockscreen\n$panel\n$power\n$windows"

if [ -n "$CMD_FEATURE" ]; then
    FEATURE="$CMD_FEATURE"
else
    CHOICE=$(echo -e "$OPTIONS" | rofi -dmenu -theme-str 'listview { lines: 8; scrollbar: false; }' -no-cache -p "Select Action")
    case "$CHOICE" in
        "$theme")       FEATURE=theme ;;
        "$wallpaper")   FEATURE=wallpaper ;;
        "$navbar")      FEATURE=navbar ;;
        "$launcher")    FEATURE=launcher ;;
        "$lockscreen")  FEATURE=lockscreen ;;
        "$panel")       FEATURE=panel ;;
        "$power")       FEATURE=power ;;
        "$windows")     FEATURE=windows ;;
        *)              exit 1 ;;
    esac
fi

case "$FEATURE" in
    theme)
        THEME_DIR="$CONF_DIR/themes"
        
        if [ ! -n "${2:-}" ]; then        
            makenotif customize preferences-desktop-theme Themes "Select a Theme." true
        fi

        CHOICE=${CMD_CHOICE:-$(find "$THEME_DIR" -mindepth 1 -maxdepth 1 -type d -printf "%f\n" 2>/dev/null | sort | rofi -dmenu -p "Select Theme")}

        if [ -n "$CHOICE" ]; then
            TARGET_SCRIPT=$(find "$THEME_DIR/$CHOICE" -maxdepth 1 -name "*.sh" | head -n 1)
            
            if [ -n "$TARGET_SCRIPT" ]; then
                bash "$TARGET_SCRIPT"
                makenotif themes preferences-desktop-theme Themes "Theme changed to: $CHOICE" true
            else
                echo "Error: No .sh file found in $THEME_DIR/$CHOICE"
            fi
        fi
        ;;

    lockscreen)
        SKIN_DIR="$CONF_DIR/hypr/hyprlock/skins"
        MAIN="$CONF_DIR/hypr/hyprlock.conf"

        if [ ! -n "${2:-}" ]; then        
            makenotif customize preferences-desktop-theme Lockscreen "Select a Lockscreen layout." true
        fi

        CHOICE="${CMD_CHOICE:-$(find "$SKIN_DIR" -mindepth 1 -maxdepth 1 -type d -printf "%f\n" 2>/dev/null | sort | rofi -dmenu -p "Select Lockscreen Layout")}"

        if [ -n "$CHOICE" ]; then
            TARGET_CONF="$(find "$SKIN_DIR/$CHOICE" -maxdepth 1 -name "*.conf" | head -n 1)"
            
            if [ -n "$TARGET_CONF" ]; then
                echo "source = $TARGET_CONF" > "$MAIN"
                makenotif customize preferences-desktop-theme Lockscreen "Layout changed to: $CHOICE" true
            else
                echo "Error: No .conf file found in $SKIN_DIR/$CHOICE"
            fi
        fi
        ;;
        
    wallpaper)
        SCRIPT_DIR="$CONF_DIR/hypr/scripts/wallpapers"

        if [ ! -n "${2:-}" ]; then        
            makenotif customize folder-pictures Wallpaper "Select a new background." true
        fi

        if [ "$CMD_CHOICE" == "random" ]; then
             "$SCRIPT_DIR/set-random.sh" &
        elif [ -n "$CMD_CHOICE" ]; then
             "$SCRIPT_DIR/set-wallpaper.sh" "$(basename "$CMD_CHOICE")" & 
        else
             "$SCRIPT_DIR/set-wallpaper.sh" &
        fi
        ;;

    launcher|panel|navbar|power|windows)
        apply_ui_skin "$FEATURE" "$CMD_CHOICE"
        ;;
esac
