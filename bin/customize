#!/bin/bash

CMD_FEATURE=$1
CMD_CHOICE=$2

pkill -x rofi

theme="Select Theme"
wallpaper="Select Wallpaper"
navbar="Select Navbar Skin"
launcher="Select Launcher Skin"
lockscreen="Select Lockscreen Layout"
panel="Select Control Centre Layout"
power="Select Power Options Layout"
OPTIONS="$theme\n$wallpaper\n$navbar\n$launcher\n$lockscreen\n$panel\n$power"

if [ -n "$CMD_FEATURE" ]; then
    FEATURE="$CMD_FEATURE"
else
    CHOICE=$(echo -e "$OPTIONS" | rofi -dmenu -theme-str 'listview { lines: 7; scrollbar: false; }' -no-cache -p "Select Action")
    case "$CHOICE" in
	"$theme")	FEATURE=theme ;;
        "$wallpaper")   FEATURE=wallpaper ;;
        "$navbar")      FEATURE=navbar ;;
        "$launcher")    FEATURE=launcher ;;
        "$lockscreen")  FEATURE=lockscreen ;;
        "$panel")       FEATURE=panel ;;
        "$power")       FEATURE=power ;;
        *)              exit 1 ;;
    esac
fi

NAVBAR_MODE_FILE="$HOME/.cache/nekoroshell/navbar_mode"
NAVBAR_HOVER_CONF="$HOME/.cache/nekoroshell/navbar-hover.conf"
HYPR="$HOME/.config/hypr/user/configs/windowrules.conf"
MANAGEMENT_MODE=$(cat "$NAVBAR_MODE_FILE" 2>/dev/null || echo "static")

case $FEATURE in
    theme)
	THEME_DIR="$HOME/.config/themes"
	
	if [ ! -n "$2" ]; then        
	    makenotif customize preferences-desktop-theme Themes "Select a Theme." true
        fi

	CHOICE=${CMD_CHOICE:-$(find "$THEME_DIR" -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | sort | rofi -dmenu -p "Select Theme")}

	if [ -n "$CHOICE" ]; then
            TARGET_SCRIPT=$(find "$THEME_DIR/$CHOICE" -maxdepth 1 -name "*.sh" | head -n 1)
            
            if [ -n "$TARGET_SCRIPT" ]; then
	        bash "$TARGET_SCRIPT"
                makenotif themes preferences-desktop-theme Themes "Theme changed to: $CHOICE" true
            else
                echo "Error: No .sh file found in $THEME_DIR/$CHOICE"
            fi
        fi
	;;

    lockscreen)
        SKIN_DIR="$HOME/.config/hypr/hyprlock/skins"
        MAIN="$HOME/.config/hypr/hyprlock.conf"

	if [ ! -n "$2" ]; then        
	    makenotif customize preferences-desktop-theme Lockscreen "Select a Lockscreen layout." true
        fi

	CHOICE=${CMD_CHOICE:-$(find "$SKIN_DIR" -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | sort | rofi -dmenu -p "Select Lockscreen Layout")}

        if [ -n "$CHOICE" ]; then
            TARGET_CONF=$(find "$SKIN_DIR/$CHOICE" -maxdepth 1 -name "*.conf" | head -n 1)
            
            if [ -n "$TARGET_CONF" ]; then
                echo "source = $TARGET_CONF" > "$MAIN"
                makenotif customize preferences-desktop-theme Lockscreen "Layout changed to: $CHOICE" true
            else
                echo "Error: No .conf file found in $SKIN_DIR/$CHOICE"
            fi
        fi
        ;;
        
    wallpaper)
        SCRIPT_DIR="$HOME/.config/hypr/scripts/wallpapers"

	if [ ! -n "$2" ]; then        
	    makenotif customize folder-pictures Wallpaper "Select a new background." true
        fi

	if [ "$CMD_CHOICE" == "random" ]; then
	     "$SCRIPT_DIR/set-random.sh" &
	elif [ -n "$CMD_CHOICE" ]; then
             "$SCRIPT_DIR/set-wallpaper.sh" "$(basename "$CMD_CHOICE")" & 
        else
             "$SCRIPT_DIR/set-wallpaper.sh" &
        fi
        ;;

    launcher|panel|navbar|power)
        case $FEATURE in
            launcher)
                NAME="Launcher"; ICON="preferences-desktop-theme"; MSG="Select a Launcher skin."
                DIR="$HOME/.config/rofi/skins"; CONFIG="$HOME/.config/rofi/config.rasi"
                ;;
            panel)
                NAME="Control Centre"; ICON="preferences-desktop-theme"; MSG="Select Control Centre style."
                DIR="$HOME/.config/swaync/skins"; CONFIG="$HOME/.config/swaync/config.json"; STYLE="$HOME/.config/swaync/style.css"
                ;;
            navbar)
                NAME="Navbar"; ICON="preferences-desktop-theme"; MSG="Select a Navbar skin."
                DIR="$HOME/.config/waybar/skins"; CONFIG="$HOME/.config/waybar/config.jsonc"; STYLE="$HOME/.config/waybar/style.css"
                ;;
            power)
                NAME="Power Options"; ICON="preferences-desktop-theme"; MSG="Select a Power Options layout."
                DIR="$HOME/.config/wlogout/skins"; CONFIG="$HOME/.config/wlogout/layout"; STYLE="$HOME/.config/wlogout/style.css"
                ;;
        esac

        if [ -n "$2" ]; then
            CHOICE="$2"
        else
            makenotif customize "$ICON" "$NAME" "$MSG" true
            CHOICE=$(ls "$DIR" | rofi -dmenu -p "Select $NAME Skin")
        fi

        if [ -n "$CHOICE" ]; then
            PATH_SKIN="$DIR/$CHOICE"

	    if [ ! -d "$PATH_SKIN" ]; then
                echo "Error: Skin '$CHOICE' not found in $DIR"
                exit 1
            fi

            sed -i "\|^source = $DIR/|d" "$HYPR"
	    if [[ -f "$PATH_SKIN/layerrule.conf" ]]; then
                echo "source = $PATH_SKIN/layerrule.conf" >> "$HYPR"
	    fi

            case $FEATURE in
                launcher)
            	    echo "@import \"$PATH_SKIN/config.rasi\"" > "$CONFIG"
            	    echo "@import \"$PATH_SKIN/style.rasi\"" >> "$CONFIG"
                    ;;
                panel)
            	    echo "@import \"$PATH_SKIN/style.css\";" > "$STYLE"
                    cp "$PATH_SKIN/config.json" "$CONFIG"
                    swaync-client -R
                    swaync-client -rs
                    ;;
		power)
            	    echo "@import \"$PATH_SKIN/style.css\";" > "$STYLE"
                    cp "$PATH_SKIN/layout" "$CONFIG"
		    ;;
                navbar)
            	    echo "@import \"$PATH_SKIN/style.css\";" > "$STYLE"
                    echo "{ \"include\": [ \"$PATH_SKIN/layout.jsonc\" ] }" > "$CONFIG"
		    cp "$PATH_SKIN/navbar-hover.conf" $NAVBAR_HOVER_CONF

		    killall -q navbar-hover navbar-watcher 2>/dev/null || true
		    killall -q waybar 2>/dev/null || true
		    sleep 0.2

		    if [ "$MANAGEMENT_MODE" = "static" ]; then
				waybar &
		    elif [ "$MANAGEMENT_MODE" = "hover" ]; then
				navbar-hover &
		    else
				navbar-watcher &
		    fi
                    ;;
            esac

            makenotif customize "$ICON" "$NAME" "Skin changed to: $CHOICE" true
        fi
        ;;
esac
