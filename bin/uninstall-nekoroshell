#!/bin/bash

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "# ======================================================= #"
echo -e "#             NeKoRoSHELL Uninstallation Utility          #"
echo -e "# ======================================================= #\n"

echo -e "${YELLOW}WARNING: This script will remove all NeKoRoSHELL configurations, scripts, and services.${NC}"
echo -e "System packages (Hyprland, Waybar, etc.) will NOT be uninstalled."
echo -e "If backups of your original configs exist, this script will attempt to restore them.\n"

echo -ne "${RED}Are you absolutely sure you want to proceed? (y/n): ${NC}"
read -r confirm
if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo -e "${GREEN}Uninstallation aborted.${NC}"
    exit 0
fi

echo -e "\n${BLUE}Stopping and disabling NeKoRoSHELL services...${NC}"

if command -v systemctl >/dev/null 2>&1; then
    SERVICES=("waybar" "swaync" "navbar" "navbar-hover" "navbar-watcher")
    
    for svc in "${SERVICES[@]}"; do
        if systemctl --user is-active --quiet "$svc.service" 2>/dev/null; then
            systemctl --user stop "$svc.service" 2>/dev/null
        fi
        if systemctl --user is-enabled --quiet "$svc.service" 2>/dev/null; then
            systemctl --user disable "$svc.service" 2>/dev/null
        fi
    done
    
    rm -f "$HOME/.config/systemd/user/navbar"*
    systemctl --user daemon-reload
    echo -e "${GREEN}Services stopped and removed.${NC}"
fi

echo -e "\n${BLUE}Removing NeKoRoSHELL configs and restoring backups...${NC}"

CONFIGS=(btop cava fastfetch hypr hypremoji kitty rofi swaync themes wallpapers wallust waybar)

for conf in "${CONFIGS[@]}"; do
    target_dir="$HOME/.config/$conf"
    
    if [[ -d "$target_dir" ]]; then
        rm -rf "$target_dir"
        echo -e "  Removed ${YELLOW}$conf${NC} configuration."
    fi

    latest_backup=$(ls -1d "${target_dir}_backup_"* 2>/dev/null | tail -n 1)
    
    if [[ -n "$latest_backup" ]]; then
        mv "$latest_backup" "$target_dir"
        echo -e "  [${GREEN}Restored${NC}] $(basename "$latest_backup") -> $conf"
    fi
done

echo -e "\n${BLUE}Cleaning up NeKoRoSHELL scripts and binaries...${NC}"

for bin_dir in "$HOME/.local/bin/nekoroshell" "$HOME/bin/nekoroshell"; do
    if [[ -d "$bin_dir" ]]; then
        rm -rf "$bin_dir"
        echo -e "  Removed directory: ${YELLOW}$bin_dir${NC}"
    fi
done

for misc_file in .p10k.zsh .face.icon change-avatar.sh; do
    if [[ -f "$HOME/$misc_file" ]]; then
        rm -f "$HOME/$misc_file"
        echo -e "  Removed file: ${YELLOW}$misc_file${NC}"
    fi
done

echo -e "\n${BLUE}Removing injected NeKoRoSHELL path variables from shell profiles...${NC}"

clean_shell_rc() {
    local shell_rc="$1"
    if [[ -f "$shell_rc" ]]; then
        if grep -q "# --- NeKoRoSHELL START ---" "$shell_rc"; then
            sed -i '/# --- NeKoRoSHELL START ---/,/# --- NeKoRoSHELL END ---/d' "$shell_rc"
            echo -e "  Cleaned ${GREEN}$shell_rc${NC}"
        fi
    fi
}

clean_shell_rc "$HOME/.bashrc"
clean_shell_rc "$HOME/.zshrc"

echo -e "\n${GREEN}Uninstallation complete!${NC}"
echo -e "You may need to log out and log back in, or restart your computer, for all changes to fully take effect."
